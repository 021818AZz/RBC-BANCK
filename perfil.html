<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .responsive-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .smaller-text {
            font-size: 0.85rem;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-slate-100 text-neutral-900 min-h-screen font-sans">
    <div class="max-w-[500px] mx-auto min-h-screen pb-24">
        <!-- Toast para mensagens -->
        <div id="toast" class="toast hidden">
            <p id="toast-message"></p>
        </div>

        <div class="px-4 pt-6 pb-5">
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <div class="relative w-16 h-16 flex-shrink-0">
                        <img id="profile-img-preview" src="https://www.diariodeinvestimentos.com.br/wp-content/uploads/2021/06/Qual-o-seu-perfil-de-investidor-e-as-aplicacoes-mais-adequadas-a-ele.jpg" alt="Foto de Perfil" class="w-full h-full rounded-full object-cover border-2 border-blue-500 shadow">
                    </div>
                    <div class="min-w-0">
                        <p id="user-id" class="text-sm text-dark font-medium responsive-text">ID: 0</p>
                        <p id="user-balance" class="text-lg font-bold text-dark">KZ 0,00</p>
                    </div>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <a href="recarregar.html" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 transition text-white font-semibold py-1 px-3 rounded-lg shadow whitespace-nowrap text-sm">Recarregar</a>
                    <a href="sacar.html" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:brightness-110 transition text-white font-semibold py-1 px-3 rounded-lg shadow whitespace-nowrap text-sm">Sacar</a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 px-4">
            <div class="bg-white rounded-xl p-3 shadow text-center">
                <p class="text-xs text-gray-500">Investimento Total</p>
                <p id="total-investido" class="text-base font-bold text-blue-600">KZ 0.00</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow text-center">
                <p class="text-xs text-gray-500">Total de retiradas</p>
                <p id="total-retiradas" class="text-base font-bold text-blue-600">KZ 0.00</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow text-center">
                <p class="text-xs text-gray-500">Receita de hoje</p>
                <p id="receita-hoje" class="text-base font-bold text-blue-600">KZ 0.00</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow text-center">
                <p class="text-xs text-gray-500">Rendimento total</p>
                <p id="rendimento-total" class="text-base font-bold text-blue-600">KZ 0.00</p>
            </div>
        </div>

        <div class="mt-5 px-4">
            <a href="team.html">
                <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow">
                    <div class="flex items-center gap-2">
                        <img class="w-8 h-8 rounded-full" src="https://cdn-icons-png.flaticon.com/512/147/147144.png" alt="">
                        <p class="font-medium text-gray-800">Equipe</p>
                    </div>
                    <span class="text-sm text-gray-400">›</span>
                </div>
            </a>
        </div>

        <div class="mt-5 px-4 space-y-3 text-sm">
            <a href="historicodeposito.html" class="bg-white p-3 rounded-xl shadow flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/Y2TN1Cy8/history.gif" class="w-5" alt="">
                    Histórico de Depósitos
                </div>
                <span>›</span>
            </a>
            <a href="history_retiradas.html" class="bg-white p-3 rounded-xl shadow flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/Y2TN1Cy8/history.gif" class="w-5" alt="">
                    Histórico de Retiradas
                </div>
                <span>›</span>
            </a>
            <a href="iban.html" class="bg-white p-3 rounded-xl shadow flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/J4WDrDFw/banksvg.png" class="w-5" alt="">
                    Número da Conta Bancária
                </div>
                <span>›</span>
            </a>
            <a href="alterar.html" class="bg-white p-3 rounded-xl shadow flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/NGRFzGjd/download.png" class="w-5" alt="">
                    Alterar Senha
                </div>
                <span>›</span>
            </a>
            <a target="_blank" href="online.html" class="bg-white p-3 rounded-xl shadow flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/yNw6L24q/supportsvg.gif" class="w-5" alt="">
                    Serviço Online
                </div>
                <span>›</span>
            </a>
            <a href="#" class="bg-white p-3 rounded-xl shadow flex opacity-40 items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://i.postimg.cc/QxX8YpPM/google-play.png" class="w-5" alt="">
                    Baixar App
                </div>
                <span>›</span>
            </a>
        </div>

        <div class="text-center mt-6">
            <button onclick="logout()" class="text-gray-500 text-sm">Terminar Sessão</button>
        </div>

        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[500px] z-50 shadow-xl border-t border-blue-100 rounded-t-2xl overflow-hidden">
            <ul class="flex justify-around items-center py-2 bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 text-white text-xs">
                <li>
                    <a href="dashboard.html" class="flex flex-col items-center gap-0.5 text-white/70">
                        <i class='bx bxs-home text-[22px] '></i>
                        <span>Início</span>
                    </a>
                </li>
                <li>
                    <a href="renda.html" class="flex flex-col items-center gap-0.5 text-white/70">
                        <i class='bx bxs-dollar-circle text-[22px] '></i>
                        <span>Renda</span>
                    </a>
                </li>
                <li>
                    <a href="team.html" class="flex flex-col items-center gap-0.5 text-white/70">
                        <i class='bx bxs-star text-[22px] '></i>
                        <span>VIP</span>
                    </a>
                </li>
                <li>
                    <a href="iban.html" class="flex flex-col items-center gap-0.5 text-white/70">
                        <i class='bx bxs-bank text-[22px] '></i>
                        <span>Bancária</span>
                    </a>
                </li>
                <li>
                    <a href="perfil.html" class="flex flex-col items-center gap-0.5 text-white font-bold">
                        <i class='bx bxs-user text-[22px] bx-tada'></i>
                        <span>Perfil</span>
                    </a>
                </li>
            </ul>
        </nav>

        <script>
          // Constantes
const CACHE_KEY = 'userDataCache';
const CACHE_EXPIRATION = 3 * 1000; // 3 segundos em milissegundos
const UPDATE_INTERVAL = 3 * 1000; // 3 segundos em milissegundos

            // Função para mostrar toast
            function showToast(message, duration = 3000) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                toastMessage.textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, duration);
            }

            // Função para formatar valores monetários no padrão KZ
            function formatarMoedaKZ(valor) {
                return 'KZ ' + Number(valor).toFixed(2)
                    .replace('.', ',')
                    .replace(/(\d)(?=(\d{3})+\,)/g, '$1.');
            }

            // Função para salvar dados no cache
            function saveToCache(data) {
                const cacheData = {
                    data: data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            }

            // Função para obter dados do cache
            function getFromCache() {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (!cachedData) return null;
                
                const parsedData = JSON.parse(cachedData);
                const now = new Date().getTime();
                
                // Verifica se os dados estão expirados
                if (now - parsedData.timestamp > CACHE_EXPIRATION) {
                    return null;
                }
                
                return parsedData.data;
            }

            // Função para atualizar a interface com os dados
            function updateUI(data) {
                if (!data) return;
                
                const user = data.usuario || {};
                
                // Atualiza informações básicas
                document.getElementById('user-id').textContent = `ID: ${user.telefone || 'N/A'}`;
                document.getElementById('user-balance').textContent = formatarMoedaKZ(user.saldo || 0);
                document.getElementById('receita-hoje').textContent = formatarMoedaKZ(user.receitaDeHoje || 0);
                document.getElementById('rendimento-total').textContent = formatarMoedaKZ(user.rendimentoTotal || 0);
                
                // Ajusta a exibição do ID
                adjustIdDisplay();
                
                // Atualiza investimentos e retiradas se estiverem nos dados
                if (data.investimentos) {
                    const totalInvestido = data.investimentos.reduce((sum, inv) => sum + inv.valor, 0);
                    document.getElementById('total-investido').textContent = formatarMoedaKZ(totalInvestido);
                }
                
                if (data.withdrawals) {
                    const totalRetiradas = data.withdrawals.reduce((sum, w) => sum + w.amount, 0);
                    document.getElementById('total-retiradas').textContent = formatarMoedaKZ(totalRetiradas);
                }
            }

            // Função para carregar todos os dados do usuário
            async function loadAllUserData() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = 'index.html';
                        return null;
                    }

                    // Carrega dados do usuário
                    const userResponse = await fetch('https://bd-uopv.onrender.com/me', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!userResponse.ok) {
                        throw new Error('Erro ao carregar dados do usuário');
                    }

                    const userData = await userResponse.json();

                    // Carrega investimentos
                    const investimentosResponse = await fetch('https://bd-uopv.onrender.com/meus-investimentos', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    let investimentos = [];
                    if (investimentosResponse.ok) {
                        const investimentosData = await investimentosResponse.json();
                        investimentos = investimentosData.investimentos || [];
                    }

                    // Carrega retiradas
                    const retiradasResponse = await fetch('https://bd-uopv.onrender.com/withdrawals', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    let retiradas = [];
                    if (retiradasResponse.ok) {
                        const retiradasData = await retiradasResponse.json();
                        retiradas = retiradasData.withdrawals || [];
                    }

                    // Combina todos os dados
                    const combinedData = {
                        usuario: userData.usuario,
                        investimentos: investimentos,
                        withdrawals: retiradas
                    };

                    // Salva no cache
                    saveToCache(combinedData);
                    
                    return combinedData;
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    return null;
                }
            }

            // Função para fazer logout
            function logout() {
                localStorage.clear();
                window.location.href = 'index.html';
            }

            // Função para ajustar a exibição do ID conforme necessário
            function adjustIdDisplay() {
                const idElement = document.getElementById('user-id');
                const container = idElement.parentElement;
                
                if (idElement.scrollWidth > container.offsetWidth) {
                    idElement.classList.add('smaller-text');
                    if (idElement.scrollWidth > container.offsetWidth) {
                        idElement.style.textOverflow = 'ellipsis';
                    }
                } else {
                    idElement.classList.remove('smaller-text');
                    idElement.style.textOverflow = 'clip';
                }
            }

            // Função para atualização silenciosa em segundo plano
            async function silentUpdate() {
                try {
                    const newData = await loadAllUserData();
                    if (newData) {
                        updateUI(newData);
                    }
                } catch (error) {
                    console.error('Erro na atualização silenciosa:', error);
                }
            }

            // Inicializa a aplicação
            async function initApp() {
                // Primeiro carrega os dados do cache (se existirem)
                const cachedData = getFromCache();
                if (cachedData) {
                    updateUI(cachedData);
                }
                
                // Depois faz uma requisição para atualizar os dados
                const freshData = await loadAllUserData();
                if (freshData) {
                    updateUI(freshData);
                } else if (!cachedData) {
                    showToast('Erro ao carregar dados do usuário');
                }
                
                // Configura a atualização periódica
                setInterval(silentUpdate, UPDATE_INTERVAL);
            }

            // Carrega os dados quando a página é aberta
            window.addEventListener('DOMContentLoaded', () => {
                initApp();
                window.addEventListener('resize', adjustIdDisplay);
            });

            // Função para formatar valores monetários em inputs
            function formatarMoeda(input) {
                let valor = input.value.replace(/\D/g, '');
                valor = (Number(valor)/100).toFixed(2) + '';
                valor = valor.replace(".", ",");
                input.value = 'KZ ' + valor;
            }
        </script>
    </div>
</body>
</html>